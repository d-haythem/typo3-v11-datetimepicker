/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","flatpickr/flatpickr.min","TYPO3/CMS/Typo3Datetimepicker/flatpickr/plugins/shortcut-buttons.min","TYPO3/CMS/Core/DocumentService","moment","TYPO3/CMS/Backend/Storage/Persistent","TYPO3/CMS/Core/Event/ThrottleEvent"],(function(e,t,a,n,i,r,o,l){"use strict";class d{static formatDateForHiddenField(e,t){return"time"!==t&&"timesec"!==t||e.year(1970).month(0).date(1),e.format()}constructor(e){var t;this.fieldSelector=".t3js-datetimepicker",this.format=(void 0!==(null===(t=null===opener||void 0===opener?void 0:opener.top)||void 0===t?void 0:t.TYPO3)?opener.top:top).TYPO3.settings.DateTimePicker.DateFormat,i.ready().then(()=>{this.initialize(e)})}initialize(t){let a;if(t instanceof HTMLElement){if(void 0!==t.dataset.datepickerInitialized)return;a=[t]}else console.warn("Initializing all date pickers globally has been marked as deprecated. Please pass a specific element."),a=Array.from(document.querySelectorAll(t||this.fieldSelector)).filter(e=>void 0===e.dataset.datepickerInitialized);if(0===a.length)return;let n=o.get("lang");n?"ch"===n&&(n="zh"):n="default",a.forEach(t=>{t.dataset.datepickerInitialized="1",e(["flatpickr/locales"],()=>{this.initializeField(t,n)})})}initializeField(e,t){const n=this.getScrollEvent(),i=this.getDateOptions(e);i.locale=t,i.onOpen=[()=>{n.bindTo(document.querySelector(".t3js-module-body"))}],i.onClose=()=>{n.release()};const o=a(e,i);e.addEventListener("input",()=>{const e=o._input.value,t=o.parseDate(e);e===o.formatDate(t,o.config.dateFormat)&&o.setDate(e)}),e.addEventListener("keyup",e=>{"Escape"===e.key&&o.close()}),e.addEventListener("change",t=>{t.stopImmediatePropagation();const a=t.target,n=e.parentElement.parentElement.querySelector('input[type="hidden"]');if(""!==a.value){const e=a.dataset.dateType,t=r.utc(a.value,a._flatpickr.config.dateFormat);t.isValid()?n.value=d.formatDateForHiddenField(t,e):a.value=d.formatDateForHiddenField(r.utc(n.value),e)}else n.value="";a.dispatchEvent(new Event("formengine.dp.change"))})}getScrollEvent(){return new l("scroll",()=>{const e=document.querySelector(".flatpickr-input.active");if(null===e)return;const t=e.getBoundingClientRect(),a=e._flatpickr.calendarContainer.offsetHeight;let n,i;window.innerHeight-t.bottom<a&&t.top>a?(n=t.y-a-2,i="arrowBottom"):(n=t.y+t.height+2,i="arrowTop"),e._flatpickr.calendarContainer.style.top=n+"px",e._flatpickr.calendarContainer.classList.remove("arrowBottom","arrowTop"),e._flatpickr.calendarContainer.classList.add(i)},15)}getDateOptions(e){const t=this.format,a=e.dataset.dateType,i=new Date,o={allowInput:!0,dateFormat:"",defaultDate:e.value,defaultHour:i.getHours(),defaultMinute:i.getMinutes(),enableSeconds:!1,enableTime:!1,formatDate:(e,t)=>r(e).format(t),parseDate:(e,t)=>r(e,t,!0).toDate(),maxDate:"",minDate:"",minuteIncrement:1,noCalendar:!1,weekNumbers:!0,plugins:[n({theme:"dark",button:[{label:top.TYPO3.lang["labels.datepicker.today"]||"Today"}],onClick:(e,t)=>{t.setDate(new Date,!0)}})]};switch(a){case"datetime":o.dateFormat=t[1],o.enableTime=!0;break;case"date":o.dateFormat=t[0];break;case"time":o.dateFormat="HH:mm",o.enableTime=!0,o.noCalendar=!0;break;case"timesec":o.dateFormat="HH:mm:ss",o.enableSeconds=!0,o.enableTime=!0,o.noCalendar=!0;break;case"year":o.dateFormat="Y"}return"undefined"!==e.dataset.dateMindate&&(o.minDate=e.dataset.dateMindate),"undefined"!==e.dataset.dateMaxdate&&(o.maxDate=e.dataset.dateMaxdate),o}}return new d}));